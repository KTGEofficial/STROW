<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Video to STROW</title>
  <style>
    :root{
      --c-cyan:#00FFFF;
      --c-green:#00FF7F;
      --shadow:0 4px 8px rgba(0,255,127,.3);
      --shadow-hover:0 6px 12px rgba(0,255,127,.4);
      --glow-green:0 0 8px rgba(0,255,127,.4);
      --glow-cyan:0 0 8px rgba(0,255,255,.5);
    }

    html,body{height:100%;}
    html{margin:0;padding:0;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:linear-gradient(to bottom left,hsl(180 96% 96%),hsl(150 96% 96%));}
    body{margin:0;padding:0;overflow-y:auto;overflow-x:hidden;position:relative;z-index:1}

    .grid-overlay{position:fixed;inset:0;background-image:linear-gradient(to right,rgba(255,255,255,.5) 8px,transparent 1px),linear-gradient(to bottom,rgba(255,255,255,.5) 8px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

    .wrap{position:relative;min-height:100svh;padding:2rem;display:grid;place-items:start center}
    .card{width:min(100%,760px);background:rgba(255,255,255,.6);backdrop-filter:saturate(140%) blur(6px);border-radius:1.25rem;padding:1.25rem;border:1px solid hsl(150 60% 85% / .6);box-shadow:0 10px 24px rgba(0,0,0,.05)}
    h1{margin:.25rem 0 1rem 0;font-size:clamp(1.25rem,1.2rem+1.2vw,1.75rem)}
    .muted{color:#335;opacity:.7}

    form{display:grid;gap:1rem}
    label{font-weight:600}

    /* Inputs */
    input[type="text"], input[type="url"], input[type="datetime-local"], select, textarea{
      background:#fff;border:3px solid transparent;border-radius:1rem;padding:.6rem 1rem;font-size:1rem;width:100%;max-width:100%;box-sizing:border-box;outline:none;background-image:linear-gradient(to bottom left,var(--c-cyan),var(--c-green)),white;background-origin:border-box;background-clip:padding-box,border-box;box-shadow:var(--glow-green);transition:box-shadow .3s ease
    }
    input[type="text"]:focus, input[type="url"]:focus, input[type="datetime-local"]:focus, select:focus, textarea:focus{box-shadow:var(--glow-cyan)}
    textarea{resize:vertical}

    .row{display:grid;gap:.5rem}

    /* Button */
    .btn{color:#fff;font-size:1rem;font-weight:700;padding:.75rem 1.5rem;border:none;border-radius:1rem;cursor:pointer;background-image:linear-gradient(to bottom left,var(--c-cyan),var(--c-green));transition:transform .2s ease, box-shadow .2s ease;box-shadow:var(--shadow);display:inline-flex;align-items:center;justify-content:center;gap:.5rem}
    .btn:hover{transform:scale(1.05);box-shadow:var(--shadow-hover)}
    .btn:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,255,127,.2)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none;box-shadow:var(--shadow)}

    /* Custom checkbox */
    .custom-checkbox{display:inline-flex;align-items:center;gap:.5rem;font-size:1rem;cursor:pointer;user-select:none}
    .custom-checkbox input[type="checkbox"]{display:none}
    .checkmark{width:20px;height:20px;border-radius:6px;background-image:linear-gradient(to bottom left,var(--c-cyan),var(--c-green));box-shadow:0 2px 6px rgba(0,255,127,.3);position:relative;transition:box-shadow .2s ease}
    .custom-checkbox:hover .checkmark{box-shadow:0 4px 10px rgba(0,255,127,.4)}
    .custom-checkbox input[type="checkbox"]:checked + .checkmark::after{content:"";position:absolute;left:6px;top:2px;width:6px;height:12px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}
    .custom-checkbox input[type="checkbox"]:checked + .checkmark{box-shadow:var(--glow-cyan)}

    /* Video */
    .video-box{width:min(100%,720px)}
    iframe#videoPreview{width:100%;aspect-ratio:16/9;border:0;border-radius:.75rem;background:#000}

    .help{font-size:.9rem}
    .status{padding:.75rem 1rem;border-radius:.75rem;background:#fff;box-shadow:var(--glow-green);border:1px solid hsl(150 60% 85% / .6);display:none}
    .status.show{display:block}
    .status.error{box-shadow:0 0 0 3px hsl(0 80% 60% / .15)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="grid-overlay" aria-hidden="true"></div>
  <noscript><div class="card" style="margin:1rem auto;max-width:760px">JavaScript is required for STROW uploads.</div></noscript>

  <div class="wrap">
    <div class="card" role="region" aria-labelledby="title">
      <h1 id="title">Upload Video to STROW</h1>
      <p class="muted help">Paste a YouTube or Google Drive link. We’ll generate a preview and prepare a STROW ID.</p>

      <form id="strowForm" novalidate>
        <div class="row">
          <label for="videoLink">Video Link (YouTube / Google Drive)</label>
          <input type="url" id="videoLink" name="videoLink" inputmode="url" placeholder="https://youtu.be/… or https://drive.google.com/file/d/…" required>
        </div>

        <div class="row">
          <label for="videoPreview">Sample Video <span id="sampleLinkTxt" class="muted help">(STROW Link will appear after session is prepared)</span></label>
          <div class="video-box">
            <iframe id="videoPreview" title="Video preview" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
          </div>
        </div>

        <div class="row">
          <label for="aspectRatio">Aspect Ratio</label>
          <select id="aspectRatio" name="aspectRatio">
            <option value="16:9" selected>16:9</option>
            <option value="9:16">9:16</option>
            <option value="4:3">4:3</option>
            <option value="19:10">19:10</option>
            <option value="phi">φ:1</option>
          </select>
        </div>

        <div class="row">
          <label for="videoTitle">Video Title</label>
          <input type="text" id="videoTitle" name="videoTitle" maxlength="200" placeholder="Optional">
        </div>

        <div class="row">
          <label for="videoDescription">Video Description</label>
          <textarea id="videoDescription" name="videoDescription" rows="3" maxlength="5000" placeholder="Optional"></textarea>
        </div>

        <div class="row">
          <label for="spreadsheetLink">Link to Spreadsheet</label>
          <input type="url" id="spreadsheetLink" name="spreadsheetLink" inputmode="url" placeholder="Optional">
        </div>

        <div class="row">
          <label for="formLink">Form Link / Voter Link</label>
          <input type="url" id="formLink" name="formLink" inputmode="url" placeholder="Optional">
        </div>

        <div class="row" style="display:flex;gap:1rem;flex-wrap:wrap">
          <label class="custom-checkbox">
            <input type="checkbox" id="isPrivate" name="isPrivate">
            <span class="checkmark" aria-hidden="true"></span>
            <span>Is Private</span>
          </label>

          <label class="custom-checkbox">
            <input type="checkbox" id="hasDeadline" name="hasDeadline" checked>
            <span class="checkmark" aria-hidden="true"></span>
            <span>Is There a Deadline?</span>
          </label>
        </div>

        <div class="row">
          <label for="deadline">Deadline</label>
          <input type="datetime-local" id="deadline" name="deadline">
        </div>

        <div class="row">
          <label for="emails">Emails (comma separated)</label>
          <textarea id="emails" name="emails" rows="2" placeholder="name@example.com, another@example.com"></textarea>
        </div>

        <div class="row">
          <label for="emailTitle">Email Title</label>
          <input type="text" id="emailTitle" name="emailTitle" maxlength="300" placeholder="Optional">
        </div>

        <div class="row">
          <label for="emailDescription">Email Description</label>
          <textarea id="emailDescription" name="emailDescription" rows="3" maxlength="5000" placeholder="Optional"></textarea>
        </div>

        <div class="row" style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
          <button type="submit" id="uploadButton" class="btn">Upload</button>
          <span id="sessionHint" class="muted help">Preparing session…</span>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    // ======= Config =======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyw3wYd9S7pVg2vucq7RRk8qKp1dzn2Sq9n5NCRXx-Td1Dh2Vt_nGkR9HKp3ZUlKOYd/exec";

    // ======= Elements =======
    const strowForm = document.getElementById('strowForm');
    const uploadButton = document.getElementById('uploadButton');
    const videoLinkInput = document.getElementById('videoLink');
    const videoPreview = document.getElementById('videoPreview');
    const aspectRatioSelect = document.getElementById('aspectRatio');
    const deadlineToggle = document.getElementById('hasDeadline');
    const deadlineInput = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const sampleLinkTxt = document.getElementById('sampleLinkTxt');
    const sessionHint = document.getElementById('sessionHint');

    // ======= State =======
    let videoID = null;
    let username = null;

    // ======= Helpers =======
    function setStatus(msg, isError = false){
      statusEl.textContent = msg || '';
      statusEl.classList.toggle('show', !!msg);
      statusEl.classList.toggle('error', !!isError);
    }

    function debounce(fn, ms){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(null,args),ms)}}

    function updateAspectRatio(){
      const ratio = aspectRatioSelect.value;
      let ar = '16/9';
      switch(ratio){
        case '16:9': ar = '16/9'; break;
        case '9:16': ar = '9/16'; break;
        case '4:3': ar = '4/3'; break;
        case '19:10': ar = '19/10'; break;
        case 'phi': ar = '1.618/1'; break; // φ:1
      }
      videoPreview.style.aspectRatio = ar;
    }

    function parseVideoUrl(url){
      try{
        const u = new URL(url);
        // YouTube
        if((/^(www\.)?youtube\.com$/i).test(u.hostname)){
          const id = u.searchParams.get('v');
          if(id && /^[a-zA-Z0-9_-]{11}$/.test(id)){
            return { provider:'youtube', id, embed:`https://www.youtube.com/embed/${id}` };
          }
        }
        if((/^(youtu\.be)$/i).test(u.hostname)){
          const id = u.pathname.split('/')[1];
          if(id && /^[a-zA-Z0-9_-]{11}$/.test(id)){
            return { provider:'youtube', id, embed:`https://www.youtube.com/embed/${id}` };
          }
        }
        // Google Drive
        if((/^(drive\.google\.com)$/i).test(u.hostname)){
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('d');
          const id = idx !== -1 ? parts[idx+1] : null;
          if(id){
            return { provider:'gdrive', id, embed:`https://drive.google.com/file/d/${id}/preview` };
          }
        }
      }catch(e){/* ignore */}
      return null;
    }

    const updateVideoPreview = debounce(()=>{
      const url = videoLinkInput.value.trim();
      const parsed = parseVideoUrl(url);
      if(parsed){
        videoPreview.src = parsed.embed; // Do not overwrite the user's input field
        setStatus('Preview loaded.');
      }else{
        videoPreview.removeAttribute('src');
        setStatus('Enter a valid YouTube or Google Drive URL to preview.');
      }
    }, 250);

    async function getRawFingerprintData(){
      try{
        const traits = [
          navigator.userAgent,
          navigator.language,
          screen.width,
          screen.height,
          screen.colorDepth,
          (new Date()).getTimezoneOffset(),
          navigator.platform,
          navigator.hardwareConcurrency,
          navigator.deviceMemory || 'unknown'
        ];
        return traits.join('::');
      }catch(e){
        return String(Math.random());
      }
    }

    async function generateHexFingerprint(rawData){
      try{
        const encoder = new TextEncoder();
        const buffer = await crypto.subtle.digest('SHA-256', encoder.encode(rawData));
        return Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){
        // Fallback non-crypto hash (not secure, but avoids breaking the flow)
        let h=0;for(let i=0;i<rawData.length;i++){h=((h<<5)-h)+rawData.charCodeAt(i);h|=0}
        return (h>>>0).toString(16);
      }
    }

    async function prepareUploadSession(){
      sessionHint.textContent = 'Preparing session…';
      try{
        const raw = await getRawFingerprintData();
        const fingerprint = await generateHexFingerprint(raw);
        const query = new URLSearchParams({ mode:'upload', fingerprint }).toString();
        const res = await fetch(`${ENDPOINT}?${query}`, { method:'GET', credentials:'omit' });
        const result = await res.json();

        if(result && result.redirect){
          // NOTE: You said to ignore the video redirect; keeping behavior but you can remove this block.
          window.location.href = 'https://ktgeofficial.github.io/STROW/accountchange.html';
          return;
        }

        videoID = result.videoID || null;
        username = result.username || null;

        if(videoID){
          sampleLinkTxt.textContent = `STROW Link: https://ktgeofficial.github.io/video.html?id=${videoID}`;
          sampleLinkTxt.classList.remove('muted');
          setStatus('Session ready. You can upload now.');
        }else{
          setStatus('Session prepared, but video ID not provided by server.', true);
        }
      }catch(err){
        console.error(err);
        setStatus('Could not prepare upload session. Please try reloading the page.', true);
      }finally{
        sessionHint.textContent = '';
      }
    }

    function validateEmails(raw){
      if(!raw.trim()) return true;
      const emails = raw.split(',').map(s=>s.trim()).filter(Boolean);
      const re = /^(?:[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})$/i;
      return emails.every(e=>re.test(e));
    }

    function onDeadlineToggle(){
      const enabled = deadlineToggle.checked;
      deadlineInput.disabled = !enabled;
      if(!enabled){ deadlineInput.value = ''; }
    }

    async function handleSubmit(ev){
      ev.preventDefault();
      setStatus('');

      // Basic validations
      const parsed = parseVideoUrl(videoLinkInput.value.trim());
      if(!parsed){
        setStatus('Please provide a valid YouTube or Google Drive link.', true);
        videoLinkInput.focus();
        return;
      }

      const emailsRaw = document.getElementById('emails').value || '';
      if(!validateEmails(emailsRaw)){
        setStatus('One or more emails look invalid. Separate with commas.', true);
        return;
      }

      // Build payload
      const formData = new FormData(strowForm);
      const data = {};
      for(const [k,v] of formData.entries()){ data[k] = v; }
      data.isPrivate = document.getElementById('isPrivate').checked;
      data.hasDeadline = document.getElementById('hasDeadline').checked;
      data.videoID = videoID;
      data.username = username;
      data.mode = 'uploading';

      if(!data.videoID){
        setStatus('Still preparing your session. Please wait a moment and try again.', true);
        return;
      }

      // Disable button during submit
      uploadButton.disabled = true;
      uploadButton.setAttribute('aria-busy','true');
      setStatus('Uploading…');

      try{
        const query = new URLSearchParams(data).toString();
        const res = await fetch(`${ENDPOINT}?${query}`, { method:'GET', credentials:'omit' });
        const ok = res.ok;
        let message = 'Uploaded.';
        try{ const j = await res.json(); if(j && j.message) message = j.message; }catch{ /* ignore */ }
        if(!ok){ throw new Error(message || 'Upload failed'); }
        setStatus(message || 'Upload complete!');
        strowForm.reset();
        updateAspectRatio();
        videoPreview.removeAttribute('src');
      }catch(err){
        console.error(err);
        setStatus(err.message || 'Upload failed. Please try again.', true);
      }finally{
        uploadButton.disabled = false;
        uploadButton.removeAttribute('aria-busy');
      }
    }

    // ======= Wire up =======
    window.addEventListener('DOMContentLoaded', ()=>{
      updateAspectRatio();
      onDeadlineToggle();
      prepareUploadSession();

      aspectRatioSelect.addEventListener('change', updateAspectRatio);
      videoLinkInput.addEventListener('input', updateVideoPreview);
      deadlineToggle.addEventListener('change', onDeadlineToggle);
      strowForm.addEventListener('submit', handleSubmit);
    });
  </script>
</body>
</html>
