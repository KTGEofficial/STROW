<html><head><title>Upload to STROW</title><link rel="icon" href="favicon.ico" type="image/x-icon"><style id="dynamic-theme"></style>
  <script>
    const lightCSS = `
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background: linear-gradient(to bottom left, hsl(180, 96%, 96%), hsl(150, 96%, 96%));
        font-family: sans-serif;
      }

      .grid-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(to right, rgba(255, 255, 255, 0.5) 8px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.5) 8px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: 0;
      }

      .content {
        position: relative;
        z-index: 1;
        padding: 2rem;
        text-align: center;
      }
    `;

    const darkCSS = `
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background: linear-gradient(to bottom left, hsl(240, 96%, 16%), hsl(0, 0%, 0%), hsl(332, 96%, 32%));
        font-family: sans-serif;
        color: white;
      }

      .grid-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(to right, rgba(255, 255, 255, 0.125) 8px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.125) 8px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: 0;
      }

      .content {
        position: relative;
        z-index: 1;
        padding: 2rem;
        text-align: center;
      }
    `;

    function applyTheme() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const styleTag = document.getElementById('dynamic-theme');
      styleTag.textContent = prefersDark ? darkCSS : lightCSS;
    }

    applyTheme();

    // Optional: Listen for changes in system theme
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
  </script><style>input[type=text],input[type=url]{transition:all .3s ease;background-color:#fff;border:3px solid transparent;border-radius:1rem;padding:.6rem 1rem;font-size:1rem;width:100%;max-width:100%;box-sizing:border-box;outline:none;background-image:linear-gradient(to bottom left,#0ff,#00ff7f),#fff;background-origin:border-box;background-clip:padding-box,border-box;box-shadow:0 0 8px rgba(0,255,127,.4);transition:box-shadow .3s ease}input[type=text]:focus,input[type=url]:focus{box-shadow:0 0 8px rgba(0,255,255,.5)}input[type=datetime-local]{background-color:#fff;border:3px solid transparent;border-radius:1rem;padding:.6rem 1rem;font-size:1rem;width:100%;max-width:100%;box-sizing:border-box;outline:none;font-family:sans-serif;background-image:linear-gradient(to bottom left,#0ff,#00ff7f),#fff;background-origin:border-box;background-clip:padding-box,border-box;box-shadow:0 0 8px rgba(0,255,127,.4);transition:box-shadow .3s ease}input[type=datetime-local]:focus{box-shadow:0 0 8px rgba(0,255,255,.5)}select,textarea{background-color:#fff;border:3px solid transparent;border-radius:1rem;padding:.6rem 1rem;font-size:1rem;width:100%;max-width:100%;box-sizing:border-box;outline:none;font-family:sans-serif;resize:vertical;background-image:linear-gradient(to bottom left,#0ff,#00ff7f),#fff;background-origin:border-box;background-clip:padding-box,border-box;box-shadow:0 0 8px rgba(0,255,127,.4);transition:box-shadow .3s ease}select:focus,textarea:focus{box-shadow:0 0 8px rgba(0,255,255,.5)}input[type=submit]{color:#fff;font-size:1rem;font-weight:700;padding:.75rem 1.5rem;border:none;border-radius:1rem;cursor:pointer;background-image:linear-gradient(to bottom left,#0ff,#00ff7f);transition:transform .2s ease,box-shadow .2s ease;box-shadow:0 4px 8px rgba(0,255,127,.3)}input[type=submit]:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,255,127,.4)}input[type=submit]:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,255,127,.2)}.custom-checkbox{display:inline-flex;align-items:center;gap:.5rem;font-size:1rem;cursor:pointer;user-select:none}.custom-checkbox input[type=checkbox]{display:none}.custom-checkbox .checkmark{width:20px;height:20px;border-radius:6px;background-image:linear-gradient(to bottom left,#0ff,#00ff7f);box-shadow:0 2px 6px rgba(0,255,127,.3);position:relative;transition:box-shadow .2s ease}.custom-checkbox:hover .checkmark{box-shadow:0 4px 10px rgba(0,255,127,.4)}.custom-checkbox input[type=checkbox]:checked+.checkmark:after{content:"";position:absolute;left:6px;top:2px;width:6px;height:12px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}.custom-checkbox input[type=checkbox]:checked+.checkmark{box-shadow:0 0 8px rgba(0,255,255,.5)}button#uploadButton{color:#fff;font-size:1rem;font-weight:700;padding:.75rem 1.5rem;border:none;border-radius:1rem;cursor:pointer;background-image:linear-gradient(to bottom left,#0ff,#00ff7f);transition:transform .2s ease,box-shadow .2s ease;box-shadow:0 4px 8px rgba(0,255,127,.3)}button#uploadButton:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,255,127,.4)}button#uploadButton:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,255,127,.2)}
</style></head><body> <div class="grid-overlay"></div><div style="position: relative;height: 100vh;background-color: hsl(0deg 0% 100% / 0%);padding: 2rem;"> <h1>Upload Video to STROW</h1> <form id="strowForm" onsubmit="handleSubmit(event)"> <label for="videoLink">Video Link (YouTube / Google Drive):</label><br> <input type="url" id="videoLink" name="videoLink" required=""><br><br> <label for="videoContainer">Sample Video (STROW Link: https://ktgeofficial.github.io/STROW/video.html?id=Verifying....):</label><br> <div id="videoContainer" style="width: 100%; max-width: 560px;"> <iframe id="videoPreview" src="" frameborder="0" allowfullscreen="" style="width: 100%; height: 315px;"></iframe> </div><br><br> <label for="aspectRatio">Aspect Ratio:</label><br> <select id="aspectRatio" name="aspectRatio"> <option value="16:9">16:9</option> <option value="9:16">9:16</option> <option value="4:3">4:3</option> <option value="19:10">19:10</option> <option value="phi">φ:1</option> <option value="21:9">21:9</option> </select><br><br> <label for="videoTitle">Video Title:</label><br> <input type="text" id="videoTitle" name="videoTitle"><br><br> <label for="videoDescription">Video Description:</label><br> <textarea id="videoDescription" name="videoDescription" rows="3"></textarea><br><br> <label for="spreadsheetLink">Link to Spreadsheet:</label><br> <input type="url" id="spreadsheetLink" name="spreadsheetLink"><br><br> <label for="formLink">Form Link / Voter Link:</label><br> <input type="url" id="formLink" name="formLink"><br><br> <label class="custom-checkbox"> Is Private: <input type="checkbox" id="isPrivate" name="isPrivate"> <span class="checkmark"></span></label><br><br> <label class="custom-checkbox"> Is There A Deadline: <input type="checkbox" id="hasDeadline" name="hasDeadline" checked=""> <span class="checkmark"></span></label><br> <br><label for="deadline">Deadline:</label><br> <input type="datetime-local" id="deadline" name="deadline"><br><br> <label for="emails">Emails (comma separated):</label><br> <textarea id="emails" name="emails" rows="2"></textarea><br><br> <label for="emailTitle">Email Title:</label><br> <input type="text" id="emailTitle" name="emailTitle"><br><br> <label for="emailDescription">Email Description:</label><br> <textarea id="emailDescription" name="emailDescription" rows="3"></textarea><br><br> <button type="submit" id="uploadButton">Upload</button> <br><br></form> </div> 
<script>async function getCookie() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith("verification" + '=')) {
      return cookie.substring("verification".length + 1);
    }
  }
  return null;
}const videoLinkInput = document.getElementById("videoLink");
const videoPreview = document.getElementById("videoPreview");
const aspectRatioSelect = document.getElementById("aspectRatio");
const videoContainer = document.getElementById("videoContainer");
const strowForm = document.getElementById("strowForm");
const uploadButton = document.getElementById("uploadButton");

let videoID = null;
let username = null;

videoLinkInput.addEventListener("input", updateVideoPreview);
aspectRatioSelect.addEventListener("change", updateAspectRatio);
uploadButton.addEventListener("click", handleSubmit);
function findColorScheme(){const e=!window.matchMedia("(prefers-color-scheme: dark)").matches;return document.getElementById("dynamic-theme").textContent=e?lightCSS:darkCSS,e}
async function getRawFingerprintData() {
  const traits = [
    navigator.userAgent,
    navigator.language,
    screen.width,
    screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    navigator.platform,
    navigator.hardwareConcurrency,
    navigator.deviceMemory || 'unknown',
  ];
  return traits.join('::');
}

async function generateHexFingerprint(rawData) {
      const encoder = new TextEncoder();
      const buffer = await crypto.subtle.digest('SHA-256', encoder.encode(rawData));
      if (await getCookie() === null) { return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join(''); } else { return await getCookie(); }
    }

async function prepareUploadSession() {
  const rawData = await getRawFingerprintData();
  const hexFingerprint = await generateHexFingerprint(rawData);
console.log(`${rawData} ${hexFingerprint}`);
  const query = new URLSearchParams({
    mode: "upload",
    fingerprint: hexFingerprint,
    colorscheme: findColorScheme()
  }).toString();

  const response = await fetch("https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?" + query);
  const result = await response.json();

  if (result.redirect) {
    window.location.href = "https://ktgeofficial.github.io/STROW/accountchange.html";
    return;
  }

  videoID = result.videoID;
  username = result.username;

  const label = document.querySelector('label[for="videoContainer"]');
  if (label) {
    label.innerHTML = `Sample Video (STROW Link: https://ktgeofficial.github.io/STROW/video.html?id=${videoID}):`;
  }
}

prepareUploadSession(); // Run on page load

(async () => {
  const rawData = await getRawFingerprintData();
  const hexFingerprint = await generateHexFingerprint(rawData);
  const query = new URLSearchParams({
    mode: "cssc",
    fingerprint: hexFingerprint,
    colorscheme: findColorScheme()
  }).toString();

  const response = await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${query}`);
  const result = await response.json();
  console.log("CSSC result:", result);
})();

console.log(`${getRawFingerprintData()} ${generateHexFingerprint(getRawFingerprintData())}`);
function updateVideoPreview() {
  const url = videoLinkInput.value.trim();
  let embedUrl = "";

  const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  if (ytMatch) {
    embedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1`;
  }

  const driveMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (driveMatch) {
    embedUrl = `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
  }

  if (embedUrl) {
    videoPreview.src = embedUrl;
    videoLinkInput.value = embedUrl;
  } else {
    videoPreview.src = "";
  }
}

function updateAspectRatio() {
  const ratio = aspectRatioSelect.value;
  let width;
  let height;
  width = 560;
  height = 315;
  switch (ratio) {
    case "16:9":  height = width * 9 / 16; break;
    case "9:16":  width = height * 16 / 9; break;
    case "4:3":   height = width * 3 / 4; break;
    case "19:10": height = width * 10 / 19; break;
    case "phi":   height = width / 1.618; break;
    case "21:9":  height = width * 9 / 21; break;
    default:
    if (/^\d+(\.\d+)?:\d+(\.\d+)?$/.test(aspectRatio)) {
      const [left, right] = aspectRatio.split(":").map(Number);
      if (left > right) {
        width = height * right / left;
      } else if (right > left) {
        height = width * right / left;
      } else {
        width = height;
      }
    }
    break;
  }

  videoPreview.style.height = `${height}px`;
}

async function handleSubmit(event) {
  event.preventDefault();

  const formData = new FormData(strowForm);
  const data = {};

  for (const [key, value] of formData.entries()) {
    data[key] = value;
  }

  data.isPrivate = document.getElementById("isPrivate").checked;
  data.hasDeadline = document.getElementById("hasDeadline").checked;
  data.videoID = videoID;
  data.username = username;
  data.fingerprint = await getRawFingerprintData();
  data.mode = "uploading";
  data.colorscheme = findColorScheme();
document.getElementById("uploadButton").disabled = true;
  // ⏰ Convert deadline to UTC ISO string
  if (data.deadline) {
    const localDate = new Date(data.deadline);
    data.deadline = localDate.toISOString(); // UTC ISO format
  }

  const query = new URLSearchParams(data).toString();
  const response = await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${query}`);
const result = await response.json();

if (result.redirect) {
  window.location.href = result.redirect;
} else { document.getElementById("uploadButton").disabled = false; }

}
</script>

 </body></html>


