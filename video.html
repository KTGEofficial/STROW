<html>
<head>
    <style id="dynamic-theme"></style>
  <script>
    const lightCSS = `body,html{margin:0;padding:0;height:100%;overflow-x:hidden;overflow-y:auto;background:linear-gradient(to bottom left,#ebffff,#ebfff5);font-family:sans-serif}.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(90deg,hsla(0,0%,100%,.5) 8px,transparent 0),linear-gradient(180deg,hsla(0,0%,100%,.5) 8px,transparent 0);background-size:40px 40px;pointer-events:none;z-index:0}.content{position:relative;z-index:1;padding:2rem;text-align:center}`;

    const darkCSS = `body,html{margin:0;padding:0;height:100%;overflow-x:hidden;overflow-y:auto;background:linear-gradient(to bottom left,#020250,#000,#a0034c);font-family:sans-serif;color:#fff}.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(90deg,hsla(0,0%,100%,.125) 8px,transparent 0),linear-gradient(180deg,hsla(0,0%,100%,.125) 8px,transparent 0);background-size:40px 40px;pointer-events:none;z-index:0}.content{position:relative;z-index:1;padding:2rem;text-align:center}`;

    function applyTheme() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const styleTag = document.getElementById('dynamic-theme');
      styleTag.textContent = prefersDark ? darkCSS : lightCSS;
    }

    applyTheme();

    // Optional: Listen for changes in system theme
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
  </script><title>Watching STROW</title><link rel="icon" href="favicon.ico" type="image/x-icon"><style>input[type=text],input[type=url]{transition:all .3s ease;background-color:#fff;border:3px solid transparent;padding:.6rem 1rem;font-size:1rem;border-radius:1rem;width:100%;max-width:100%;box-sizing:border-box;outline:none;background-image:linear-gradient(to bottom left,#0ff,#00ff7f),#fff;background-origin:border-box;background-clip:padding-box,border-box;box-shadow:0 0 8px rgba(0,255,127,.4);transition:box-shadow .3s ease}input[type=text]:focus,input[type=url]:focus{box-shadow:0 0 8px rgba(0,255,255,.5)}.button-link,.button-link:active,.button-link:focus{outline:none;border:none}.button-link{position:relative;display:inline-block;text-decoration:none;color:#fff;font-size:1rem;font-weight:700;padding:.75rem 1.5rem;border-radius:1rem;background-image:linear-gradient(to bottom left,#0ff,#00ff7f);box-shadow:0 4px 8px rgba(0,255,127,.3);cursor:pointer;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease;z-index:1}.button-link:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,255,255,.4)}.button-link:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,255,255,.2)}.ripple-outline{position:absolute;border:2px solid rgba(0,255,255,.4);border-radius:1rem;width:100%;height:100%;top:0;left:0;transform:scale(1);animation:ripple-outline-animation .8s ease-out;pointer-events:none;z-index:0}@keyframes ripple-outline-animation{0%{transform:scale(1);opacity:.8}to{transform:scale(2.5);opacity:0}}.comment-section{text-align:left;color:#000;max-width:100%;margin:0 auto}.comment{background:#fff;border-radius:1rem;padding:1rem;margin-top:1rem;box-shadow:0 0 8px rgba(0,255,127,.4);position:relative}.comment.reply{margin-left:2rem;border-left:4px solid #00ff7f}.comment-header{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.5rem}.username{font-weight:700;font-size:1.1rem}.comment-body{font-size:1rem;margin-bottom:.5rem;max-width:100%}.comment-actions{display:flex;gap:1rem}.comment-actions button{background:none;border:none;font-size:.9rem;cursor:pointer;color:#007f5f;transition:color .2s ease}.comment-actions button:hover{color:#00ff7f}.topified{background-image:linear-gradient(to bottom left,#fff,#fe467c,#cb0fb2)}.topified,.verified{color:#fff;font-weight:700;border-radius:1rem;font-size:x-small;padding:.5em}.verified{background-image:linear-gradient(to bottom left,#fff,#00ff80,#00ccad)}.caught{background-image:linear-gradient(to bottom left,#fff,#571dca,#4c0097)}.caught,.poster{color:#fff;font-weight:700;border-radius:1rem;font-size:x-small;padding:.5em}.poster{background-image:linear-gradient(to bottom left,#fff,#ffff80,#fe467c)}.staff{background-image:linear-gradient(to bottom left,#fff,#3c49fd,#2308ca)}.loved,.staff{color:#fff;font-weight:700;border-radius:1rem;font-size:x-small;padding:.5em}.loved{background-image:linear-gradient(to bottom left,#fff,#fe9446,#cb570f)}.video-reaction-bar{display:flex;justify-content:center;align-items:stretch;margin:1rem auto;border-radius:1rem;overflow:hidden;box-shadow:0 0 8px rgba(0,255,127,.4);background:#fff;padding:.5rem}.video-reaction-divider{width:2px;background:linear-gradient(180deg,#00ff7f,#0ff);margin:0 .25rem}.video-reaction-bar.comment-actions{width:auto;max-width:fit-content;display:inline-flex}</style>
</head>
<body>
    <div class="grid-overlay"></div>

<div style="position: relative; height: 100vh; background-color: hsl(0deg 0% 100% / 0%); padding: 2rem;">
  <iframe
    id="videoPreview"
    src=""
    frameborder="0"
    allowfullscreen
    style="width: 840px; height: 472.5px;">
  </iframe>
  <h1 id="videoTitle">Loading Title</h1>
  <h2 id="countdown">Waiting for deadline</h2>
  <p id="videoDescription">Loading description</p>
  <h4 id="videoAuthor">From undefined at undefined</h4>
  <p id="videoDeadline">Deadline: Loading</p><h4 id="viewCount">0 views (0 unique views)</h4>
  <a id="spreadsheetLink" class="button-link">Spreadsheet</a>
  <a id="externalLink" class="button-link">Alternate External</a><br><div class="video-reaction-bar comment-actions"><button class="like" id="videoLike" onclick="likeVideo()">Like 0</button><div class="video-reaction-divider"></div><button class="dislike" id="videoDislike" onclick="dislikeVideo()">Dislike 0</button></div>
  <h2 id="commentCount">0 Comments</h2>
<input type="text" id="comment"><br><br><button class="button-link" id="comment-button" onclick="submitComment()">Comment</button><br><div class="comment-section content" id="comment-section">
</div>
</div>
    <script>
    function computeCommentScore(comment, videoMeta) {
      const netLikes     = ((comment.likes || 0) - (comment.dislikes || 0) + 1);
      const tagMult      = getTagMultiplier(comment.tags);
      const wordMult     = wordMatchMultiplier(comment.comment, videoMeta);
      const timeMult     = getTimeMultiplier(comment.commentAge);
      
      return netLikes * tagMult * wordMult * timeMult;
    }function renderComment(e,t,n,o=!1,c){let i=[];try{i="string"==typeof t.tags?JSON.parse(t.tags):Array.isArray(t.tags)?t.tags:[]}catch{i=[]}const s=document.createElement("div");s.className=o?"comment reply":"comment",s.id=e;const a=document.createElement("div");a.className="comment-header";const r=document.createElement("strong");r.className="username",r.textContent=t.username,a.appendChild(r),i.forEach((e=>{const t=document.createElement("span");t.className=e,t.textContent=e.toUpperCase(),a.appendChild(t)})),s.appendChild(a);const m=document.createElement("div");m.className="comment-body",m.textContent=t.comment,s.appendChild(m);const l=document.createElement("div");l.className="comment-actions";const d=document.createElement("button");d.className="like",d.textContent=("liked"===t.userOpinion?"Liked ":"Like ")+(t.likes||0),d.onclick=()=>likeComment(e),l.appendChild(d);const p=document.createElement("button");p.className="dislike",p.textContent=("disliked"===t.userOpinion?"Disliked ":"Dislike ")+(t.dislikes||0),p.onclick=()=>dislikeComment(e),l.appendChild(p);const u=document.createElement("button");if(u.className="reply",u.textContent="Reply",u.onclick=()=>replyCall(e),l.appendChild(u),s.appendChild(l),o){const e=3,t=Array.from(n.children),o=t.length>e?t[e]:null;n.insertBefore(s,o)}else n.insertBefore(s,n.firstChild);t.replies&&"object"==typeof t.replies&&Object.entries(t.replies).map((([e,t])=>({id:e,comment:t,score:computeCommentScore(t,c)}))).sort(((e,t)=>t.score-e.score)).forEach((({id:e,comment:t})=>{renderComment(e,t,s,!0,c)}))}function drawComments(e,t){const n=document.getElementById("comment-section");n.innerHTML="";const o=Object.entries(e.comments).filter((([,e])=>"object"==typeof e)).map((([e,n])=>({id:e,comment:n,score:computeCommentScore(n,t)}))).sort(((e,t)=>t.score-e.score));console.table(o.map((({id:e,score:t})=>({id:e,score:t}))));for(let e=o.length-1;e>=0;e--){const{id:c,comment:i}=o[e];renderComment(c,i,n,!1,t)}}async function likeComment(e){const t=new URLSearchParams({mode:"reaction",videoID:new URLSearchParams(window.location.search).get("id"),fingerprint:await generateHexFingerprint(await getRawFingerprintData()),requestID:e,opinionSwitch:"liked",colorscheme:findColorScheme()}).toString();try{const e=await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${t}`);await e.json(),alert("Successfully toggled like!")}catch(e){alert("Failed to like comment: "+e.message)}}async function dislikeComment(e){const t=new URLSearchParams({mode:"reaction",videoID:new URLSearchParams(window.location.search).get("id"),fingerprint:await generateHexFingerprint(await getRawFingerprintData()),requestID:e,opinionSwitch:"disliked",colorscheme:findColorScheme()}).toString();try{const e=await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${t}`);await e.json(),alert("Successfully toggled dislike!")}catch(e){alert("Failed to dislike comment: "+e.message)}}
    function getTagMultiplier(t){if("string"==typeof t)try{t=JSON.parse(t)}catch{t=t.split(",").map((t=>t.trim()))}if(!Array.isArray(t)||0===t.length)return 1;let e=1;return t.includes("caught")&&(e*=1.25),t.includes("verified")&&!t.includes("Staff")&&(e*=4),t.includes("poster")&&(e*=16),t.includes("staff")&&(e*=64),e}
    function wordMatchMultiplier(t,e){const l=t.split(/\s+/).filter((t=>/\w/.test(t))).map((t=>t.toLowerCase())),h=e.split(/\s+/).filter((t=>/\w/.test(t))).map((t=>t.toLowerCase())),n=l.length>=2,a=l.map((t=>t.length)),o=n?Math.max(...a):0,r=n?Math.min(...a):0;let g=0;return l.forEach((t=>{let e=0;h.forEach((l=>{const h=Array.from({length:t.length+1},(()=>Array(l.length+1).fill(0)));for(let e=0;e<=t.length;e++)h[e][0]=e;for(let t=0;t<=l.length;t++)h[0][t]=t;for(let e=1;e<=t.length;e++)for(let n=1;n<=l.length;n++){const a=t[e-1]===l[n-1]?0:1;h[e][n]=Math.min(h[e-1][n]+1,h[e][n-1]+1,h[e-1][n-1]+a)}const n=h[t.length][l.length],a=Math.floor(t.length/2),o=Math.max(0,1-n/(a||1));n<=a&&(e=Math.max(e,o))}));const l=t.length;g+=e*(n?(3*l-4*r+o)/(o-r||1):1)})),Math.max(g,.01)}
    function getTimeMultiplier(t){const e=t/864e5;return Math.pow(.75,e)+1}
        let activeReplyTarget = null;
    
    function replyCall(id) {
      const targetComment = document.getElementById(id);
      if (!targetComment) return;
    
      // If the same comment is clicked again, cancel
      if (activeReplyTarget === id) {
        cancelReply();
        activeReplyTarget = null;
        return;
      }
    
      // If a different comment is clicked, cancel previous and proceed
      cancelReply();
    
      // Create reply hotbar
      const replyHotbar = document.createElement("div");
      replyHotbar.className = "comment-body";
      replyHotbar.id = "reply-hotbar";
    
      replyHotbar.innerHTML = `
        <br>
        <input type="text" id="reply-box">
        <br><br>
        <button class="button-link" id="reply-submission-button" onclick="submitComment('${id}')">Reply</button>
        <button class="button-link" id="reply-cancel" onclick="cancelReply()">Cancel</button>
      `;
    
      targetComment.appendChild(replyHotbar);
      activeReplyTarget = id;
    }
    
    function cancelReply() {
      const existingHotbar = document.getElementById("reply-hotbar");
      if (existingHotbar && existingHotbar.parentNode) {
        existingHotbar.parentNode.removeChild(existingHotbar);
      }
      activeReplyTarget = null;
    }
        async function getCookie() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith("verification" + '=')) {
          return cookie.substring("verification".length + 1);
        }
      }
      return null;
    }
    function findColorScheme(){const e=!window.matchMedia("(prefers-color-scheme: dark)").matches;return document.getElementById("dynamic-theme").textContent=e?lightCSS:darkCSS,e}// Function to get raw fingerprint data from various browser traits
    async function likeVideo(){const e=new URLSearchParams({mode:"videoGesture",videoID:new URLSearchParams(window.location.search).get("id"),fingerprint:await generateHexFingerprint(await getRawFingerprintData()),opinionSwitch:"liked",colorscheme:findColorScheme()}).toString();try{const i=await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${e}`);await i.json(),alert("Successfully toggled like!")}catch(e){alert("Failed to like video: "+e.message)}}async function dislikeVideo(){const e=new URLSearchParams({mode:"videoGesture",videoID:new URLSearchParams(window.location.search).get("id"),fingerprint:await generateHexFingerprint(await getRawFingerprintData()),opinionSwitch:"disliked",colorscheme:findColorScheme()}).toString();try{const i=await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${e}`);await i.json(),alert("Successfully toggled dislike!")}catch(e){alert("Failed to dislike video: "+e.message)}}async function getRawFingerprintData() {
      const traits = [
        navigator.userAgent,
        navigator.language,
        screen.width,
        screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.platform,
        navigator.hardwareConcurrency,
        navigator.deviceMemory || 'unknown',
      ];
      return traits.join('::');
    }
    
    async function generateHexFingerprint(rawData) {
          const encoder = new TextEncoder();
          const buffer = await crypto.subtle.digest('SHA-256', encoder.encode(rawData));
          if (await getCookie() === null) { return Array.from(new Uint8Array(buffer))
            .map(b => b.toString(16).padStart(2, '0'))
            .join(''); } else { return await getCookie(); }
        }
    
    // Function to update the countdown display (PATCHED)
    function updateCountdown(deadlineRaw, hasDeadline) {
      const countdownElement = document.getElementById("countdown");
    
      if (!hasDeadline || !deadlineRaw) {
        countdownElement.textContent = "No deadline";
        return;
      }
    
      // Convert deadlineRaw to a timestamp if it's a string
      let deadlineTime = typeof deadlineRaw === "number" ? deadlineRaw : Date.parse(deadlineRaw);
      if (isNaN(deadlineTime)) {
        countdownElement.textContent = "Invalid deadline date";
        return;
      }
    
      const now = Date.now();
      const distance = deadlineTime - now;
    
      if (distance <= 0) {
        countdownElement.textContent = "The deadline has passed";
        return;
      }
    
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((distance / (1000 * 60)) % 60);
      const seconds = Math.floor((distance / 1000) % 60);
    
      let partsToDisplay = [];
    
      if (days >= 1) {
        partsToDisplay.push(`${days}:${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
      } else if (hours >= 1) {
        partsToDisplay.push(`${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
      } else {
        partsToDisplay.push(`${minutes}:${String(seconds).padStart(2, '0')}`);
      }
    
      countdownElement.textContent = partsToDisplay.join("");
    }
    
    // Function to format the date and time for display
    function formatDeadline(dateString, includeTime = false, timezoneAbbreviation) {
      const date = new Date(dateString);
    
      if (isNaN(date.getTime())) {
        return "Invalid Date";
      }
    
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      let formatted = date.toLocaleDateString(undefined, options);
    
      // Add ordinal suffix (1st, 2nd, 3rd, 4th...)
      const day = date.getDate();
      const suffix = (day % 10 === 1 && day !== 11) ? 'st' :
                     (day % 10 === 2 && day !== 12) ? 'nd' :
                     (day % 10 === 3 && day !== 13) ? 'rd' : 'th';
      formatted = formatted.replace(/\d+/, day + suffix);
    
      if (includeTime) {
        const timeOptions = {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        };
        // NO timeZone property; uses the browser's local zone
        const localTime = `${date.toLocaleTimeString(undefined, timeOptions)} ${timezoneAbbreviation}`;
        formatted += ` at ${localTime}`;
      }
    
      return formatted;
    }
    
    // Main function to load video data and update the page
    async function loadVideoData() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
    
      if (!id) {
        window.location.href = "https://ktgeofficial.github.io/STROW/";
        return;
      }
    
      const rawData = await getRawFingerprintData();
      const fingerprint = await generateHexFingerprint(rawData);
    
      const query = new URLSearchParams({
        mode: "watch",
        id,
        fingerprint,
        timezoneOffset: new Date().getTimezoneOffset(),
        timezoneAbbreviation: Intl.DateTimeFormat('en-US', {timeZoneName: 'short'}).formatToParts(new Date()).find(part => part.type === 'timeZoneName')?.value,
        colorscheme: findColorScheme()
      }).toString();
    
      try {
        const response = await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${query}`);
        const result = await response.json();
    console.log(result);
        if (!result.success) {
          console.log(result);
          window.location.href = result.redirect || "https://ktgeofficial.github.io/STROW/";
          return;
        }
    
        async function makeLink(url, fetchTitle = false) {
          let text = url;
    
          if (fetchTitle && /^https?:\/\//i.test(url)) {
            try {
              const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
              const data = await response.json();
              const match = data.contents.match(/<title>(.*?)<\/title>/i);
              if (match && match[1]) text = match[1].trim();
            } catch (e) {
              console.warn("Could not fetch title for:", url, e);
            }
          }
    
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = text;
          return a;
        }
    
        // Convert deadlineRaw to timestamp once for countdown logic
        const deadlineTimestamp = typeof result.deadlineRaw === "number"
          ? result.deadlineRaw
          : Date.parse(result.deadlineRaw);
    
        document.getElementById("videoTitle").textContent = result?.title?.trim();
    
        const descriptionContainer = document.getElementById("videoDescription");
        descriptionContainer.innerHTML = "";
    
        const descriptionLines = (result?.description || "").split("\n");
        descriptionLines.forEach(line => {
          const trimmedLine = line.trim();
          if (trimmedLine) {
            const p = document.createElement("p");
            p.textContent = trimmedLine;
            descriptionContainer.appendChild(p);
          }
        });
    
        document.getElementById("videoAuthor").textContent = `From ${result.author} at ${formatDeadline(result.uploadDate, false, result.timezoneAbbreviation) || result.uploadDate}`;
        document.getElementById("videoDeadline").textContent = `Deadline: ${formatDeadline(result.deadlineRaw, true, result.timezoneAbbreviation) || "No deadline"}`; const viewCount = result.viewCount || 0; const uniqueViewCount = result.uniqueViewCount || 0; const pluralViews = viewCount !== 1 ? "views" : "view"; const pluralUnique = uniqueViewCount !== 1 ? "unique views" : "unique view"; document.getElementById("viewCount").textContent = `${viewCount} ${pluralViews} (${uniqueViewCount} ${pluralUnique})`;
        document.getElementById("spreadsheetLink").href = result.spreadsheetHref || "#";
        document.getElementById("externalLink").href = result.externalHref || "#"; if (result.userOpinion === "liked") { document.getElementById("videoLike").textContent = `Liked ${result.likeCount}`; document.getElementById("videoDislike").textContent = `Dislike ${result.dislikeCount}`; } else if (result.userOpinion === "disliked") { document.getElementById("videoLike").textContent = `Like ${result.likeCount}`; document.getElementById("videoDislike").textContent = `Disliked ${result.dislikeCount}`; } else if (result.userOpinion === "blank") { document.getElementById("videoLike").textContent = `Like ${result.likeCount}`; document.getElementById("videoDislike").textContent = `Dislike ${result.dislikeCount}`; }
    if (result.commentCount === 1) { document.getElementById("commentCount").textContent = "1 Comment"; } else {
        document.getElementById("commentCount").textContent = `${result.commentCount || 0} Comments`; }
      
    drawComments(result, `${result.title} ${result.author} ${result.description}`);
        // PATCHED DYNAMIC COUNTDOWN LOGIC
        updateCountdown(deadlineTimestamp, !!deadlineTimestamp);
        setInterval(() => updateCountdown(deadlineTimestamp, !!deadlineTimestamp), 1000);
    
        if (result.videoLink) {
          document.getElementById("videoPreview").src = result.videoLink;
          document.getElementById("videoPreview").style.width = `${result.width}px`;
          document.getElementById("videoPreview").style.height = `${result.height}px`;
        }
    
      } catch (err) {
        console.error(err);
        document.getElementById("videoTitle").textContent = "Error loading video.";
      }
    }
    // This is a quality marker for if the HTML Page loaded is the correct one for debuggers
    
    // Ok! Good to know, thanks!
    (async () => {
      const rawData = await getRawFingerprintData();
      const hexFingerprint = await generateHexFingerprint(rawData);
      const query = new URLSearchParams({
        mode: "cssc",
        fingerprint: hexFingerprint,
        colorscheme: findColorScheme()
      }).toString();
    
      const response = await fetch(`https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?${query}`);
      const result = await response.json();
      console.log("CSSC result:", result);
    })();
    
    async function submitComment(replyID) {
      let button; if (replyID !== undefined && replyID !== null && replyID !== "") { button = document.getElementById("reply-submission-button"); } else { button = document.getElementById("comment-button"); }
      button.disabled = true;
    
      try {
        let commentText; if (replyID !== undefined && replyID !== null && replyID !== "") { commentText = document.getElementById("reply-box").value.trim(); } else { commentText = document.getElementById("comment").value.trim(); }
        if (!commentText) {
          alert("Please enter a comment before submitting.");
          button.disabled = false;
          return;
        }
    
        const rawData = await getRawFingerprintData();
        const hexFingerprint = await generateHexFingerprint(rawData);
        const timestamp = new Date().toISOString();
        const urlParams = new URLSearchParams(window.location.search);
        const videoID = urlParams.get("id") || "";
        const colorscheme = findColorScheme();
        let replyof; if (replyID !== undefined && replyID !== null && replyID !== "") { replyof = replyID; } else { replyof = ""; }
    const mode = "commenting";
    
        const query = new URLSearchParams({
          comment: commentText,
          timestamp: timestamp,
          fingerprint: hexFingerprint,
          id: videoID,
          colorscheme: colorscheme,
          replyof: replyof,
    mode: mode
        }).toString();
    
        const response = await fetch("https://script.google.com/macros/s/AKfycbxrCDZ6utO2emrK95sw9lknNHAAmxgkFznLXp_ioBUuZRHUFdwuFmszsIqZFrZ0FMO-/exec?" + query);
        const result = await response.json();
    if (replyID !== undefined && replyID !== null && replyID !== "") { cancelReply(); }
        alert("Your comment has been submitted.");const { username, commentID, tags } = result;
const newComment = {
  username,
  comment: commentText,
  tags: tags,
  likes: 0,
  dislikes: 0,
  userOpinion: "blank",
  replies: {}
};
const container = replyID
  ? document.getElementById(replyID)
  : document.getElementById("comment-section");
renderComment(commentID, newComment, container, !!replyID, "");
        document.getElementById("comment").value = "";
      } catch (error) {
        console.error("Failed to submit comment:", error);
        alert("Something went wrong while submitting your comment.");
      } finally {
        button.disabled = false;
      }
    }
    
    loadVideoData();
</script>

</body>
</html>


